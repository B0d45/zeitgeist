<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zeiterfassung</title>
    
      <!-- Nostr Tools -->
    <script src="https://unpkg.com/nostr-tools@1.7.0/lib/nostr.bundle.js"></script>


    <!-- jsPDF + autoTable -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/5.0.2/jspdf.plugin.autotable.min.js"></script>

   

    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #0a2b2b;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        h1 {
            text-align: center;
            color: #333;
        }

        /* Mehr Abstand zwischen den Abschnitten */
        .timer-section,
        .project-section,
        .report-section,
        .login-section,
        .entries-section,
        .donation-section {
            margin-top: 40px;
        }

        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 4px 20px;
            cursor: pointer;
            border-radius: 4px;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        button.delete {
            background-color: #dc3545;
        }
        button.delete:hover {
            background-color: #c82333;
        }
        select, input[type="text"], input[type="date"], input[type="number"] {
            padding: 8px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
            border-radius: 4px;
            background: white;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        .timer-display {
            font-size: 24px;
            text-align: center;
            margin: 10px 0;
        }
        .error {
            color: red;
            font-size: 14px;
        }
        .hidden {
            display: none;
        }
        .edit-input {
            width: 100%;
            box-sizing: border-box;
        }
        
        .timer-section, .project-section, .report-section, .login-section, .entries-section, .donation-section {
         background: #e1e1e1ab;
         padding: 15px;
        }
        
        details summary {
    padding: 0.5rem;
    background: #eee;
    border-radius: 8px;
    width: fit-content;
    transition: background 0.2s;
}
details summary:hover {
    background: #ddd;
}
#contactsContainer div {
    padding: 0.3rem 0;
    border-bottom: 1px solid #ccc;
}

#contactsContainer {
    display: grid;
    grid-template-columns: repeat(3, 1fr); /* 3 gleich breite Spalten */
    gap: 1rem; /* Abstand zwischen den Spalten */
    padding: 0.5rem 0;
}

#contactsContainer div {
    padding: 0.5rem;
    background: #f9f9f9;
    border: 1px solid #ccc;
    border-radius: 8px;
}

    </style>
</head>
<body>
    <div class="container">
        <h1>Zeiterfassung</h1>

        <!-- Login Section -->
        <div class="login-section" id="loginSection">
            <h2>Nostr Login</h2>
            <p>Öffentlicher Schlüssel: <span id="pubkeyDisplay">Nicht eingeloggt</span></p>
            <input type="text" id="customRelayInput" placeholder="Eigenes Relay (z.B. wss://mein-relay.com oder ws://abcdefg.onion)">
            <button onclick="addCustomRelay()">Relay hinzufügen</button>
            <select id="relaySelect" multiple>
                <option value="wss://relay.damus.io">wss://relay.damus.io</option>
                <option value="wss://nostr.wine">wss://nostr.wine</option>
                <option value="wss://relay.snort.social">wss://relay.snort.social</option>
                <option value="wss://nostr.fmt.wiz.biz">wss://nostr.fmt.wiz.biz</option>
                <option value="ws://mknqnp5rmmtw7ogxjahpfawfucwltixsvi26rf2urenpvkioawmp3qyd.onion">ws://mknqnp5rmmtw7ogxjahpfawfucwltixsvi26rf2urenpvkioawmp3qyd.onion</option>
                
            </select>
            <button onclick="loginWithAlby()">Mit Alby einloggen</button>
            <button onclick="generateNostrKeys()">Neue Schlüssel generieren</button>
            <p id="generatedKeyDisplay" class="hidden"></p>
            <p class="error" id="loginError"></p>
        </div>

        <!-- Timer Section -->
        <div class="timer-section hidden" id="timerSection">
          
            <div class="timer-display" id="timerDisplay">00:00:00</div>
            <select id="projectSelect">
                <option value="">Kein Projekt auswählen</option>
            </select>
            <input type="text" id="projectFreeText" placeholder="Projekt (optional)" class="hidden">
            <select id="clientSelect">
                <option value="">Kein Klient auswählen</option>
            </select>
            <input type="text" id="clientFreeText" placeholder="Klient (optional)" class="hidden">
            <button id="startButton" onclick="startTimer()">Start</button>
            <button id="stopButton" onclick="stopTimer()" disabled>Stop</button>
        </div>

        <!-- Entries Section -->
        <div class="entries-section hidden" id="entriesSection">
          
            <table id="entriesTable">
                <thead>
                    <tr>
                        <th>Datum</th>
                        <th>Projekt</th>
                        <th>Klient</th>
                        <th>Dauer</th>
                        <th>Aktion</th>
                    </tr>
                </thead>
                <tbody id="entriesBody"></tbody>
            </table>
        </div>

        <!-- Project/Client Management -->
        <div class="project-section hidden" id="projectSection">
            <h2>Projekte und Klienten</h2>
            <input type="text" id="projectNameInput" placeholder="Projektname">
            <button onclick="addProject()">Projekt hinzufügen</button>
            <input type="text" id="clientNameInput" placeholder="Clientname">
            <button onclick="addClient()">Klient hinzufügen</button>
            <h3>Projekte</h3>
            <ul id="projectList"></ul>
            <h3>Klienten</h3>
            <ul id="clientList"></ul>
        </div>

        <!-- Report Section -->
        <div class="report-section hidden" id="reportSection">
            <h2>Berichte</h2>
            <select id="reportFilter">
                <option value="day">Tag</option>
                <option value="week">Woche</option>
                <option value="month">Monat</option>
            </select>

      <input type="date" id="reportDate">
            <label for="reportProjectFilter" style="margin-left: 10px;">Filter Projekt:</label>
            <select id="reportProjectFilter">
                <option value="all">Alle Projekte</option>
            </select>
            <label for="reportClientFilter" style="margin-left: 10px;">Filter Client:</label>
            <select id="reportClientFilter">
                <option value="all">Alle Klienten</option>
            </select>
            <button onclick="generateReport()">Bericht generieren</button>
            <button onclick="exportToPDF()">PDF Export</button>
            
            <table id="reportTable" class="hidden">
                <thead>
                    <tr>
                        <th>Datum</th>
                        <th>Projekt</th>
                        <th>Klient</th>
                        <th>Dauer</th>
                    </tr>
                </thead>
                <tbody id="reportBody"></tbody>
            </table>
            <p>Gesamtstunden: <span id="totalHours">0</span></p>
        </div>



<section id="contactsSection">
    <details>
        <summary style="cursor:pointer; font-weight: bold; margin-top: 10px;">Nostr-Kontakte anzeigen</summary>
        <div id="contactsContainer"></div>
    </details>
</section>




      <!-- Donation Section -->
<div class="donation-section hidden" id="donationSection">
    <h2>Spenden</h2>
    <div id="lightningAddressInputContainer">
        <input type="text" id="lightningAddressInput" placeholder="Deine Lightning-Adresse z.B. name@getalby.com">
        <button onclick="saveLightningAddress(event)">Adresse speichern</button>
    </div>
    <!-- Hier zeigen wir die Bestätigungsnachricht -->
   <p id="lightningAddressConfirmation" class="hidden"></p>
<button id="editLightningAddressButton" class="hidden" onclick="editLightningAddress()">Adresse ändern</button>


    <p>Spende hier einige Sats:</p>
    <input type="number" id="donationAmount" placeholder="Betrag in Sats (z.B. 1000)" min="1">
    <button onclick="makeLightningDonation()">Jetzt spenden</button>
    <p class="error" id="donationError"></p>
</div>



        <div class="donation-section hidden" id="donationSection">
            <h2>Spenden</h2>
            <p>Spende hier einige Sats:</p>
            <input type="number" id="donationAmount" placeholder="Betrag in Sats (z.B. 1000)" min="1">
            <button onclick="makeLightningDonation()">Jetzt spenden</button>
            <p class="error" id="donationError"></p>
        </div>
    </div>
    

    <script>
        const { jsPDF } = window.jspdf;
        let timerInterval = null;
        let startTime = null;
        let elapsedTime = 0;
        let isLoggedIn = false;
        let publicKey = null;
        let relays = [];
        let pool = null;

   

        // Datenstrukturen
        let timeEntries = JSON.parse(localStorage.getItem('timeEntries')) || [];
        let projects = JSON.parse(localStorage.getItem('projects')) || [];
        let clients = JSON.parse(localStorage.getItem('clients')) || [];

        // Initialisierung
     document.addEventListener('DOMContentLoaded', () => {
            setTodayDate();
            loadCustomRelay();
            updateSelectOptions(); // Diese ist für die Timer-Dropdowns
            updateReportFilterOptions(); // <-- NEU: Ruft die neue Funktion auf
            updateLists();
            updateEntriesTable();
            console.log('Initialisierte timeEntries:', timeEntries);
            toggleFreeTextFields();
            
                // Lightning-Adresse prüfen und UI anpassen
    const savedAddress = localStorage.getItem('lightningAddress');
    if (savedAddress) {
        // Eingabefeld ausblenden
        document.getElementById('lightningAddressInputContainer').classList.add('hidden');

        // Hinweistext einblenden
        const confirmation = document.getElementById('lightningAddressConfirmation');
        confirmation.textContent = `✅ Lightning-Adresse aktiviert (${savedAddress})`;
        confirmation.classList.remove('hidden');
        // NEU: auch den "Adresse ändern"-Button zeigen
    document.getElementById('editLightningAddressButton').classList.remove('hidden');
    }
  
        });

        function loginWithAlby() {
    if (!window.nostr) {
        alert("Alby-Erweiterung nicht gefunden. Bitte installiere Alby.");
        return;
    }
    if (!window.NostrTools || !window.NostrTools.SimplePool) {
        alert("NostrTools noch nicht geladen. Seite neu laden?");
        return;
    }

    window.nostr.getPublicKey()
        .then(pk => {
            publicKey = pk;
            document.getElementById('pubkeyDisplay').textContent = window.NostrTools.nip19.npubEncode(publicKey);
            isLoggedIn = true;

            const relaySelect = document.getElementById('relaySelect');
            relays = Array.from(relaySelect.selectedOptions).map(option => option.value);

console.log('Ausgewählte Relays:', relays);

            if (relays.length === 0) {
                alert("Bitte mindestens ein Relay auswählen.");
                return;
            }

            pool = new NostrTools.SimplePool();

            // Hier die Relays vorab prüfen
            checkRelayHealth(relays).then(workingRelays => {
                if (workingRelays.length === 0) {
                    alert('❌ Keines der gewählten Relays ist erreichbar. Bitte andere auswählen.');
                    return;
                }

                relays = workingRelays; // Nur die funktionierenden Relays übernehmen
                fetchNostrEvents();
                loadMyContactsAndProfiles();
                toggleSections();
            }).catch(err => {
                alert('❌ Fehler beim Testen der Relays: ' + err.message);
            });
        })
        .catch(err => {
            document.getElementById('loginError').textContent = "Login fehlgeschlagen: " + err.message;
        });
}


        function addCustomRelay() {
            const customRelayInput = document.getElementById('customRelayInput').value.trim();
            const relaySelect = document.getElementById('relaySelect');

            const isValidRelay = /^(wss:\/\/[a-zA-Z0-9-.]+)|(wss?:\/\/[a-zA-Z0-9-]+\.onion)$/.test(customRelayInput);
            if (isValidRelay) {
                const exists = Array.from(relaySelect.options).some(option => option.value === customRelayInput);
                if (!exists) {
                    const option = document.createElement('option');
                    option.value = customRelayInput;
                    option.text = customRelayInput;
                    option.selected = true;
                    relaySelect.appendChild(option);
                    localStorage.setItem('customRelay', customRelayInput);
                    document.getElementById('loginError').textContent = `Benutzerdefiniertes Relay ${customRelayInput} hinzugefügt.`;
                } else {
                    document.getElementById('loginError').textContent = 'Dieses Relay ist bereits in der Liste.';
                }
            } else {
                document.getElementById('loginError').textContent = 'Bitte eine gültige Relay-URL eingeben (z.B. wss://mein-relay.com oder ws://abcdefg.onion).';
            }
        }

        function loadCustomRelay() {
            const customRelay = localStorage.getItem('customRelay');
            if (customRelay) {
                document.getElementById('customRelayInput').value = customRelay;
                const relaySelect = document.getElementById('relaySelect');
                const option = document.createElement('option');
                option.value = customRelay;
                option.text = customRelay;
                option.selected = true;
                relaySelect.appendChild(option);
            }
        }

        function toggleFreeTextFields() {
            const projectSelect = document.getElementById('projectSelect');
            const clientSelect = document.getElementById('clientSelect');
            const projectFreeText = document.getElementById('projectFreeText');
            const clientFreeText = document.getElementById('clientFreeText');

            projectSelect.addEventListener('change', () => {
                projectFreeText.classList.toggle('hidden', projectSelect.value !== '');
                if (projectSelect.value !== '') projectFreeText.value = '';
            });

            clientSelect.addEventListener('change', () => {
                clientFreeText.classList.toggle('hidden', clientSelect.value !== '');
                if (clientSelect.value !== '') clientFreeText.value = '';
            });
        }

    function updateSelectOptions() {
    const projectSelect = document.getElementById('projectSelect');
    const clientSelect = document.getElementById('clientSelect');

    // Projekte unverändert
    projectSelect.innerHTML = '<option value="">Kein Projekt auswählen</option>' +
        projects.map(p => `<option value="${p.id}">${p.name}</option>`).join('');

    // Clients aus localStorage laden
    const clients = JSON.parse(localStorage.getItem('clients')) || [];
    clientSelect.innerHTML = '<option value="">Kein Klient auswählen</option>';
    clients.forEach(client => {
        const option = document.createElement('option');
        option.value = client.id; // numerische ID

        option.textContent = client.name;
        clientSelect.appendChild(option);
    });
}


        function updateLists() {
            const projectList = document.getElementById('projectList');
            const clientList = document.getElementById('clientList');
            projectList.innerHTML = projects.map(p => `<li>${p.name} <button class="delete" onclick="deleteProject(${p.id})">Löschen</button></li>`).join('');
            clientList.innerHTML = clients.map(c => `<li>${c.name} <button class="delete" onclick="deleteClient(${c.id})">Löschen</button></li>`).join('');
        }


function updateReportFilterOptions() {
    const reportProjectFilter = document.getElementById('reportProjectFilter');
    const reportClientFilter = document.getElementById('reportClientFilter');

    reportProjectFilter.innerHTML = '<option value="all">Alle Projekte</option>' +
        projects.map(p => `<option value="${p.id}">${p.name}</option>`).join('');

    reportClientFilter.innerHTML = '<option value="all">Alle Klienten</option>' +
    clients.map(c => `<option value="${c.id}">${c.name}</option>`).join('');

}



       function updateEntriesTable() {
    const entriesBody = document.getElementById('entriesBody');
    entriesBody.innerHTML = '';

    if (timeEntries.length === 0) {
        entriesBody.innerHTML = '<tr><td colspan="5">Keine Einträge vorhanden.</td></tr>';
        return;
    }

    const sortedEntries = [...timeEntries].sort((a, b) => b.start - a.start);

    sortedEntries.forEach(entry => {
        const projectDisplay = entry.projectName || entry.projectFreeText || 'Kein Projekt';
        const clientDisplay = entry.clientName || entry.clientFreeText || 'Kein Client';
        const durationFormatted = formatDuration(entry.duration);

        entriesBody.innerHTML += `
            <tr id="entry-${entry.id}">
                <td>${new Date(entry.start).toLocaleDateString('de-DE')}</td>
                <td class="project-cell">${projectDisplay}</td>
                <td class="client-cell">${clientDisplay}</td>
                <td>${durationFormatted}</td>
                <td>
                    <button onclick="editEntry(${entry.id})">Bearbeiten</button>
                    <button class="delete" onclick="deleteEntry(${entry.id})">Löschen</button>
                </td>
            </tr>
        `;
    });
}


        function editEntry(entryId) {
    const entry = timeEntries.find(e => e.id === entryId);
    if (!entry) return;

    const row = document.getElementById(`entry-${entryId}`);
    const projectCell = row.querySelector('.project-cell');
    const clientCell = row.querySelector('.client-cell');
    const durationCell = row.children[3];

    // Nimm die Namen aus dem Entry, sonst leerer String
    const projectValue = entry.projectName || '';
    const clientValue = entry.clientName || '';

    projectCell.innerHTML = `<input type="text" class="edit-input" value="${projectValue}">`;
    clientCell.innerHTML = `<input type="text" class="edit-input" value="${clientValue}">`;
    durationCell.innerHTML = `<input type="text" class="edit-input" value="${formatDuration(entry.duration)}" placeholder="z.B. 01:15:30">`;

    const actionCell = row.querySelector('td:last-child');
    actionCell.innerHTML = `
        <button onclick="saveEntry(${entryId})">Speichern</button>
        <button onclick="cancelEdit(${entryId})">Abbrechen</button>
    `;
}


        function saveEntry(entryId) {
    const entry = timeEntries.find(e => e.id === entryId);
    if (!entry) return;

    // Werte aus der Dropdown-Auswahl holen
    const projectSelect = document.getElementById('projectSelect');
    const clientSelect = document.getElementById('clientSelect');

    const projectName = projectSelect.options[projectSelect.selectedIndex].textContent;
    const clientName = clientSelect.options[clientSelect.selectedIndex].textContent;
    const clientPubkey = clientSelect.value;

    // Felder am Entry speichern
    entry.projectName = projectName !== 'Kein Projekt auswählen' ? projectName : '';
    entry.clientName = clientName !== 'Kein Klient auswählen' ? clientName : '';
    entry.clientPubkey = clientPubkey || '';

    saveData('timeEntries', timeEntries);  // Dein bestehendes Speicher-Utility
    updateEntriesTable();
}


        function deleteEntry(entryId) {
    if (!confirm('Möchtest du diesen Zeiteintrag wirklich löschen?')) return;

    // Finde den Eintrag, bevor er aus dem Array gefiltert wird, um seine Daten zu haben
    const entryToDelete = timeEntries.find(e => e.id === entryId);

    timeEntries = timeEntries.filter(e => e.id !== entryId);
    saveData('timeEntries', timeEntries);
    updateEntriesTable();

    // NEU: Veröffentliche ein Lösch-Event für den Zeiteintrag
    if (entryToDelete) { // Stelle sicher, dass der Eintrag gefunden wurde
        publishNostrEvent('time-entry-deleted', { id: entryId });
    }
}

        function cancelEdit(entryId) {
            updateEntriesTable();
        }

        function formatDuration(ms) {
            const hours = Math.floor(ms / 3600000);
            const minutes = Math.floor((ms % 3600000) / 60000);
            const seconds = Math.floor((ms % 60000) / 1000);
            return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }

        function exportToPDF() {
            const reportBody = document.getElementById('reportBody');
            if (!reportBody || !reportBody.hasChildNodes()) {
                alert('Bitte zuerst einen Bericht mit Einträgen generieren.');
                return;
            }

            try {
                const { jsPDF } = window.jspdf; // Get jsPDF from global scope
                const doc = new jsPDF();

                // Check if autoTable is available
                if (!doc.autoTable) {
                    throw new Error('jsPDF-AutoTable plugin is not loaded correctly.');
                }

                doc.text('Zeiterfassungs-Bericht', 10, 10);

                const rows = Array.from(reportBody.querySelectorAll('tr')).map(row =>
                    Array.from(row.querySelectorAll('td')).map(cell => cell.textContent.trim())
                );

                doc.autoTable({
                    head: [['Datum', 'Projekt', 'Client', 'Dauer']],
                    body: rows,
                    startY: 20
                });

                const totalHours = document.getElementById('totalHours').textContent;
                const y = doc.lastAutoTable?.finalY ?? 30;
                doc.text(`Gesamtstunden: ${totalHours}`, 10, y + 10);
                doc.save('zeiterfassung_bericht.pdf');

            } catch (error) {
                console.error("Fehler beim PDF-Export:", error);
                alert("Beim Erstellen der PDF ist ein Fehler aufgetreten: " + error.message);
            }
        }

        function toggleSections() {
            document.getElementById('loginSection').classList.toggle('hidden', isLoggedIn);
            document.getElementById('timerSection').classList.toggle('hidden', !isLoggedIn);
            document.getElementById('entriesSection').classList.toggle('hidden', !isLoggedIn);
            document.getElementById('projectSection').classList.toggle('hidden', !isLoggedIn);
            document.getElementById('reportSection').classList.toggle('hidden', !isLoggedIn);
            document.getElementById('donationSection').classList.toggle('hidden', !isLoggedIn);
        }

        function startTimer() {
            if (!timerInterval) {
                startTime = Date.now();
                elapsedTime = 0;
                timerInterval = setInterval(updateTimer, 1000);
                document.getElementById('startButton').disabled = true;
                document.getElementById('stopButton').disabled = false;
                window.dispatchEvent(new Event('timer-started'));
            }
        }

     function stopTimer() {
    if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
        elapsedTime = Date.now() - startTime;

        const projectSelect = document.getElementById('projectSelect');
        const clientSelect = document.getElementById('clientSelect');

        const projectId = parseInt(projectSelect.value) || null;
        const projectName = projectSelect.selectedIndex >= 0 ? projectSelect.options[projectSelect.selectedIndex].textContent : '';
        const clientId = parseInt(clientSelect.value) || null;
        const clientName = clientSelect.selectedIndex >= 0 ? clientSelect.options[clientSelect.selectedIndex].textContent : '';

        const projectFreeText = document.getElementById('projectFreeText').value || '';
        const clientFreeText = document.getElementById('clientFreeText').value || '';

        const entry = {
            id: Date.now(),
            projectId: projectId,
            clientId: clientId,
            projectName: projectId ? projectName : projectFreeText,
            clientName: clientId ? clientName : clientFreeText,
            projectFreeText: projectId ? '' : projectFreeText,
            clientFreeText: clientId ? '' : clientFreeText,
            start: startTime,
            end: Date.now(),
            duration: elapsedTime
        };

        timeEntries.push(entry);
        saveData('timeEntries', timeEntries);
        publishNostrEvent('time-entry', entry);
        updateEntriesTable();

        // Reset Timer & UI
        elapsedTime = 0;
        startTime = null;
        document.getElementById('timerDisplay').textContent = '00:00:00';
        document.getElementById('startButton').disabled = false;
        document.getElementById('stopButton').disabled = true;
        window.dispatchEvent(new Event('timer-stopped'));
    }
}




        function updateTimer() {
            elapsedTime = Date.now() - startTime;
            const hours = Math.floor(elapsedTime / 3600000);
            const minutes = Math.floor((elapsedTime % 3600000) / 60000);
            const seconds = Math.floor((elapsedTime % 60000) / 1000);
            document.getElementById('timerDisplay').textContent =
                `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }

        function generateNostrKeys() {
            try {
                const privKey = window.NostrTools.generatePrivateKey();
                const nsec = window.NostrTools.nip19.nsecEncode(privKey);
                const pubKey = window.NostrTools.getPublicKey(privKey);
                const npub = window.NostrTools.nip19.npubEncode(pubKey);
                document.getElementById('generatedKeyDisplay').textContent =
                    `Privater Schlüssel (sicher speichern!): ${nsec}\nÖffentlicher Schlüssel: ${npub}`;
                document.getElementById('generatedKeyDisplay').classList.remove('hidden');
                document.getElementById('loginError').textContent = 'Schlüssel generiert. Bitte importiere den privaten Schlüssel in Alby.';
            } catch (err) {
                document.getElementById('loginError').textContent = 'Schlüsselgenerierung fehlgeschlagen: ' + err.message;
            }
        }

        function setTodayDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('reportDate').value = today;
        }

       function generateReport() {
            const filter = document.getElementById('reportFilter').value;
            const dateInput = document.getElementById('reportDate').value;

            // NEU: Werte der Projekt- und Client-Filter abrufen
            const selectedProjectFilterId = document.getElementById('reportProjectFilter').value;
            const selectedClientFilterId = document.getElementById('reportClientFilter').value;

            if (!dateInput) {
                // Bitte beachten: alert() solltest du später durch ein eigenes Modal ersetzen!
                alert('Bitte ein Datum auswählen.');
                return;
            }
            const selectedDate = new Date(dateInput);
            selectedDate.setHours(0, 0, 0, 0);
            let startDate, endDate;
            if (filter === 'day') {
                startDate = new Date(selectedDate);
                endDate = new Date(selectedDate);
                endDate.setDate(endDate.getDate() + 1);
            } else if (filter === 'week') {
                startDate = new Date(selectedDate);
                startDate.setDate(startDate.getDate() - startDate.getDay() + 1);
                endDate = new Date(startDate);
                endDate.setDate(endDate.getDate() + 7);
            } else if (filter === 'month') {
                startDate = new Date(selectedDate.getFullYear(), selectedDate.getMonth(), 1);
                endDate = new Date(selectedDate.getFullYear(), selectedDate.getMonth() + 1, 1);
            }

            // Anpassung der Filter-Logik:
            const filteredEntries = timeEntries.filter(entry => {
                const entryDate = new Date(entry.start);
                entryDate.setHours(0, 0, 0, 0);

                // 1. Datum filter anwenden
                const dateMatch = entryDate >= startDate && entryDate < endDate;

                // 2. Projektfilter anwenden
                let projectMatch = true;
                if (selectedProjectFilterId !== 'all') {
                    // Überprüfe, ob der Eintrag eine Projekt-ID hat UND ob diese mit der ausgewählten ID übereinstimmt
                    // parseInt() ist wichtig, da die Werte aus dem Select-Feld Strings sind, die IDs aber Zahlen sind
                    projectMatch = (entry.projectId === parseInt(selectedProjectFilterId));
                }

               // 3. Clientfilter
let clientMatch = true;
if (selectedClientFilterId !== 'all') {
    clientMatch = (entry.clientPubkey === selectedClientFilterId);
}


                // Ein Eintrag muss alle Filter-Bedingungen erfüllen
                return dateMatch && projectMatch && clientMatch;
            });
            
            filteredEntries.sort((a, b) => b.start - a.start);

            const reportBody = document.getElementById('reportBody');
            reportBody.innerHTML = '';
            let totalDuration = 0;

            if (filteredEntries.length === 0) {
                reportBody.innerHTML = '<tr><td colspan="4">Keine Einträge für den Zeitraum und die ausgewählten Filter gefunden.</td></tr>';
            } else {
                filteredEntries.forEach(entry => {
    // Hier nutzen wir die Namen, die beim Stoppen der Zeit gespeichert wurden
    const projectDisplay = entry.projectName || entry.projectFreeText || 'Kein Projekt';
    const clientDisplay = entry.clientName || entry.clientFreeText || 'Kein Client';
    const durationFormatted = formatDuration(entry.duration);

    totalDuration += entry.duration;

    reportBody.innerHTML += `
        <tr>
            <td>${new Date(entry.start).toLocaleDateString('de-DE')}</td>
            <td>${projectDisplay}</td>
            <td>${clientDisplay}</td>
            <td>${durationFormatted}</td>
        </tr>
    `;
});

            }

            document.getElementById('totalHours').textContent = formatDuration(totalDuration);
            document.getElementById('reportTable').classList.remove('hidden');
        }


async function fetchNostrEvents() {
    try {
        const filter = {
            kinds: [30000],
            authors: [publicKey]
        };
        const events = await pool.list(relays, [filter]);
        console.log(`[Fetch Debug] Abgerufene Nostr-Events (Anzahl: ${events.length}):`, events);

        processFetchedEvents(events); // hier rufst du deinen bisherigen Event-Processor auf
    } catch (err) {
        console.error('❌ [Fetch Error] Fehler beim Abrufen der Events:', err);
        document.getElementById('loginError').textContent = 'Fehler beim Laden der Daten vom Relay.';
    }
}





function processFetchedEvents(events) {
    // Sortiere Events chronologisch
    events.sort((a, b) => a.created_at - b.created_at);

    const latestTimeEntries = new Map();
    const latestProjects = new Map();
    const latestClients = new Map();
    const deletedProjectIds = new Set();
    const deletedClientIds = new Set();
    const deletedTimeEntryIds = new Set();

    events.forEach(event => {
        const type = event.tags.find(tag => tag[0] === 't')?.[1];
        try {
            const data = JSON.parse(event.content);

            if (type === 'project-deleted') {
                deletedProjectIds.add(data.id);
                latestProjects.delete(data.id);
            } else if (type === 'client-deleted') {
                deletedClientIds.add(data.id);
                latestClients.delete(data.id);
            } else if (type === 'time-entry-deleted') {
                deletedTimeEntryIds.add(data.id);
                latestTimeEntries.delete(data.id);
            } else if (type === 'time-entry') {
                latestTimeEntries.set(data.id, data);
            } else if (type === 'project') {
                latestProjects.set(data.id, data);
            } else if (type === 'client') {
                latestClients.set(data.id, data);
            }
        } catch (e) {
            console.error('❌ [Fetch Error] Fehler beim Parsen eines Event-Contents:', event, e);
        }
    });

    timeEntries = Array.from(latestTimeEntries.values()).filter(
        entry => !deletedTimeEntryIds.has(entry.id) &&
                 (entry.projectId === null || !deletedProjectIds.has(entry.projectId)) &&
                 (entry.clientId === null || !deletedClientIds.has(entry.clientId))
    );

    projects = Array.from(latestProjects.values()).filter(p => !deletedProjectIds.has(p.id));
    clients = Array.from(latestClients.values()).filter(c => !deletedClientIds.has(c.id));

    saveData('timeEntries', timeEntries);
    saveData('projects', projects);
    saveData('clients', clients);

    updateSelectOptions();
    updateLists();
    updateEntriesTable();
    updateReportFilterOptions();
    window.dispatchEvent(new Event('data-loaded'));

    console.log('✅ [Fetch Debug] Daten erfolgreich verarbeitet:', { projects, clients, timeEntries });
}





    async function publishNostrEvent(type, data) {
            try {
                const event = {
                    kind: 30000,
                    pubkey: publicKey,
                    created_at: Math.floor(Date.now() / 1000),
                    tags: [['t', type]],
                    content: JSON.stringify(data)
                };
                const signedEvent = await window.nostr.signEvent(event);
                await pool.publish(relays, signedEvent);
                console.log(`Nostr-Event gesendet (${type}):`, signedEvent);
            } catch (err) {
                console.error('Fehler beim Senden des Nostr-Events:', err);
                document.getElementById('loginError').textContent = 'Fehler beim Speichern der Daten im Relay. Lokale Daten wurden gespeichert.';
            }
        }

        function saveData(key, data) {
            localStorage.setItem(key, JSON.stringify(data));
        }

        async function makeLightningDonation() {
    try {
        if (!window.webln) {
            throw new Error('WebLN nicht verfügbar. Installiere z.B. Alby.');
        }

        await window.webln.enable();

        // 📍 Hier neue Adresse aus dem localStorage holen:
        const lightningAddress = localStorage.getItem('lightningAddress');
        if (!lightningAddress) {
            throw new Error('Bitte erst oben deine Lightning-Adresse speichern.');
        }

        const amount = parseInt(document.getElementById('donationAmount').value) || 1000;
        const username = lightningAddress.split('@')[0];
        const lnurlData = await fetch(`https://getalby.com/.well-known/lnurlp/${username}`).then(res => res.json());
        const invoiceResponse = await fetch(`${lnurlData.callback}?amount=${amount * 1000}`).then(res => res.json());
        await window.webln.sendPayment(invoiceResponse.pr);

        document.getElementById('donationError').textContent = 'Danke für deine Spende!';
    } catch (err) {
        document.getElementById('donationError').textContent = 'Spende fehlgeschlagen: ' + err.message;
    }
}


        function addProject() {
            const input = document.getElementById('projectNameInput');
            const name = input.value.trim();
            if (!name) return;
            const id = Date.now();
            projects.push({ id, name });
            saveData('projects', projects);
            updateSelectOptions();
            updateLists();
            input.value = '';
            publishNostrEvent('project', { id, name });
              updateReportFilterOptions(); // <-- NEU: Aktualisiert die Report-Filter
        }

        function addClient() {
            const input = document.getElementById('clientNameInput');
            const name = input.value.trim();
            if (!name) return;
            const id = Date.now();
            clients.push({ id, name });
            saveData('clients', clients);
            updateSelectOptions();
            updateLists();
            input.value = '';
            publishNostrEvent('client', { id, name });
            updateReportFilterOptions(); // <-- NEU: Aktualisiert die Report-Filter
        }
        
        
          function deleteProject(projectId) {
            if (!confirm('Möchtest du dieses Projekt wirklich löschen? Verknüpfte Zeiteinträge bleiben erhalten, aber als Freitext.')) return;
            const project = projects.find(p => p.id === projectId);
            projects = projects.filter(p => p.id !== projectId);
            timeEntries.forEach(entry => {
                if (entry.projectId === projectId) {
                    entry.projectFreeText = project?.name || '';
                    entry.projectId = null;
                    publishNostrEvent('time-entry', entry);
                }
            });
            saveData('projects', projects);
            saveData('timeEntries', timeEntries);
            publishNostrEvent('project-deleted', { id: projectId });
            updateSelectOptions();
            updateLists();
            updateEntriesTable();
        }

        function deleteClient(clientId) {
            if (!confirm('Möchtest du diesen Client wirklich löschen? Verknüpfte Zeiteinträge bleiben erhalten, aber als Freitext.')) return;
            const client = clients.find(c => c.id === clientId);
            clients = clients.filter(c => c.id !== clientId);
            timeEntries.forEach(entry => {
                if (entry.clientId === clientId) {
                    entry.clientFreeText = client?.name || '';
                    entry.clientId = null;
                    publishNostrEvent('time-entry', entry);
                }
            });
            saveData('clients', clients);
            saveData('timeEntries', timeEntries);
            publishNostrEvent('client-deleted', { id: clientId });
            updateSelectOptions();
            updateLists();
            updateEntriesTable();
        }




  (function enableTimerPersistence() {
    const TIMER_KEY = 'persistentTimerStart';
    const PROJECT_KEY = 'persistentProject';
    const CLIENT_KEY = 'persistentClient';

    // ⚡ Wird automatisch aufgerufen, nachdem die Daten aus Nostr geladen wurden:
    window.addEventListener('data-loaded', () => {
        const savedStart = sessionStorage.getItem(TIMER_KEY);
        const savedProject = sessionStorage.getItem(PROJECT_KEY);
        const savedClient = sessionStorage.getItem(CLIENT_KEY);

        if (savedStart && !timerInterval) {
            // Starte Timer automatisch wieder
            startTime = parseInt(savedStart, 10);
            timerInterval = setInterval(updateTimer, 1000);
            document.getElementById('startButton').disabled = true;
            document.getElementById('stopButton').disabled = false;

            // Projekt wiederherstellen
            if (savedProject) {
                const { id, freeText } = JSON.parse(savedProject);
                document.getElementById('projectSelect').value = id || '';
                document.getElementById('projectFreeText').value = freeText || '';
                document.getElementById('projectFreeText').classList.toggle('hidden', !!id);
            }

            // Klient wiederherstellen
            if (savedClient) {
                const { id, freeText } = JSON.parse(savedClient);
                document.getElementById('clientSelect').value = id || '';
                document.getElementById('clientFreeText').value = freeText || '';
                document.getElementById('clientFreeText').classList.toggle('hidden', !!id);
            }

            console.log('[Timer] Timer beim Reload automatisch wiederhergestellt.');
        }
    });

    // ⚡ Schreibt die aktuellen Werte beim Starten in sessionStorage
    window.addEventListener('timer-started', () => {
        sessionStorage.setItem(TIMER_KEY, String(startTime));
        sessionStorage.setItem(PROJECT_KEY, JSON.stringify({
            id: document.getElementById('projectSelect').value || null,
            freeText: document.getElementById('projectFreeText').value || ''
        }));
        sessionStorage.setItem(CLIENT_KEY, JSON.stringify({
            id: document.getElementById('clientSelect').value || null,
            freeText: document.getElementById('clientFreeText').value || ''
        }));
        console.log('[Timer] Timer-Start und Werte gespeichert.');
    });

    // ⚡ Löscht die Werte beim Stoppen aus sessionStorage
    window.addEventListener('timer-stopped', () => {
        sessionStorage.removeItem(TIMER_KEY);
        sessionStorage.removeItem(PROJECT_KEY);
        sessionStorage.removeItem(CLIENT_KEY);
        console.log('[Timer] SessionStorage gelöscht.');
    });
})();



function saveLightningAddress(event) {
    const addr = document.getElementById('lightningAddressInput').value.trim();
    if (!addr) {
        alert('Bitte eine Lightning-Adresse eingeben.');
        return;
    }

    // Speichern
    localStorage.setItem('lightningAddress', addr);

    // Eingabefeld & Button ausblenden
    document.getElementById('lightningAddressInputContainer').classList.add('hidden');

    // Bestätigungsnachricht zeigen
    const confirmation = document.getElementById('lightningAddressConfirmation');
    confirmation.textContent = `✅ Lightning-Adresse aktiviert (${addr})`;
    confirmation.classList.remove('hidden');

    // Erfolgsmeldung
     alert('Lightning-Adresse gespeichert und aktiviert!');

    // kein Default-Button-Verhalten
    event.preventDefault();
}


function editLightningAddress() {
    // Zeige Eingabefeld und Button wieder
    document.getElementById('lightningAddressInputContainer').classList.remove('hidden');

    // Bereits gespeicherte Adresse ins Eingabefeld übernehmen
    const savedAddress = localStorage.getItem('lightningAddress');
    document.getElementById('lightningAddressInput').value = savedAddress || '';

    // Bestätigung und Edit-Button ausblenden
    document.getElementById('lightningAddressConfirmation').classList.add('hidden');
    document.getElementById('editLightningAddressButton').classList.add('hidden');
}



async function loadMyContactsAndProfiles() {
    try {
        console.log('⏳ Lade Kontakte ...');

        const contactsFilter = { kinds: [3], authors: [publicKey] };
        const contactsEvents = await pool.list(relays, [contactsFilter]);
        let nostrContacts = [];

        if (contactsEvents.length > 0) {
            const contactsEvent = contactsEvents.sort((a, b) => a.created_at - b.created_at).pop();
            nostrContacts = contactsEvent.tags
                .filter(tag => tag[0] === 'p')
                .map(tag => tag[1]);
        }

        console.log('nostrContacts:', nostrContacts);

        // Lade die Profile der gefundenen Kontakte
        await loadProfilesForContacts(nostrContacts);
        console.log('✅ Fertig mit loadMyContactsAndProfiles');
    } catch (err) {
        console.error('❌ Fehler beim Laden der Kontakte:', err);
    }
}


// Hilfsfunktion für die Profile
async function loadProfilesForContacts(nostrContacts) {
    try {
        const profilePromises = nostrContacts.map(async pubkey => {
            const profileEvents = await pool.list(relays, [{ kinds: [0], authors: [pubkey] }]);
            if (profileEvents.length === 0) return null;

            // Nimm das neueste Profil
            return profileEvents.sort((a, b) => a.created_at - b.created_at).pop();
        });

        const profileEvents = await Promise.all(profilePromises);

        profileEvents.forEach((profileEvent, index) => {
            if (profileEvent) {
                const profile = JSON.parse(profileEvent.content);
                displayContact(profile, nostrContacts[index]);
            }
        });
    } catch (err) {
        console.error('❌ Fehler beim Laden der Profile:', err);
    }
}





function displayContact(profile, pubkey) {
    const container = document.getElementById('contactsContainer');
    const div = document.createElement('div');

  const nameToShow = profile.name || pubkey.slice(0, 8);
const pictureUrl = profile.picture || 'https://via.placeholder.com/40'; // Platzhalter, falls kein Bild

div.innerHTML = `
    <div style="display:flex; align-items:center; gap:0.5rem; margin-bottom:0.5rem;">
        <img src="${pictureUrl}" alt="${nameToShow}" style="width:40px; height:40px; border-radius:50%;">
        <strong>${nameToShow}</strong>
    </div>
    <button onclick="sendTipTo('${profile.lud16 || profile.lnurl}', '${nameToShow}')">💸 Danke senden</button>
    <button onclick="addAsClient('${nameToShow}', '${pubkey}', '${profile.lud16 || profile.lnurl || ''}')">➕ Als Client hinzufügen</button>

`;

    container.appendChild(div);
}




async function sendTipTo(lightningAddress, name) {
    if (!lightningAddress) {
        alert(`Kein Lightning-Address-Feld für ${name} gefunden.`);
        return;
    }

    try {
        await window.webln.enable();
        const amount = prompt(`Wie viele Sats willst du an ${name} senden?`, 1000);
        if (!amount) return;

        const username = lightningAddress.split('@')[0];
        const lnurlData = await fetch(`https://getalby.com/.well-known/lnurlp/${username}`).then(res => res.json());
        const invoiceResponse = await fetch(`${lnurlData.callback}?amount=${amount * 1000}`).then(res => res.json());
        await window.webln.sendPayment(invoiceResponse.pr);

        alert(`✅ Zahlung an ${name} erfolgreich!`);
    } catch (error) {
        alert(`Fehler beim Senden an ${name}: ${error.message}`);
    }
}




function addAsClient(name, pubkey, lightning) {
    let clients = JSON.parse(localStorage.getItem('clients')) || [];

    if (clients.some(client => client.pubkey === pubkey)) {
        alert(`${name} ist bereits als Client vorhanden.`);
        return;
    }

    const id = Date.now(); // numerische ID
    const newClient = { id, name, pubkey, lightning };
    clients.push(newClient);
    localStorage.setItem('clients', JSON.stringify(clients));
    updateSelectOptions();
    updateLists();
    updateReportFilterOptions();
    alert(`✅ ${name} als Client hinzugefügt!`);
}



// Test-Version von checkRelayHealth:
async function checkRelayHealth(relays, timeoutMs = 5000) {
    const workingRelays = [];

    for (const url of relays) {
        try {
            const relay = pool.ensureRelay(url);
            // Warte kurz, damit die Verbindung zustande kommt
            await new Promise(res => setTimeout(res, 2000));
            workingRelays.push(url);
            console.log(`✅ Relay OK (einfache Prüfung): ${url}`);
        } catch (err) {
            console.warn(`❌ Relay down oder fehlerhaft: ${url}`, err.message || err);
        }
    }

    return workingRelays;
}

</script>
</body>
</html>
